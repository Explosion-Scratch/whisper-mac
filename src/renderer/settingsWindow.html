<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhisperMac Settings</title>
    <script>if (window.__electronLog) { Object.assign(console, window.__electronLog); }</script>
    <link rel="stylesheet" href="../photon/css/photon.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/duotone/style.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css"
    />
    <style>
      [v-cloak] {
        display: none;
      }
      /* Design System Variables */
      :root {
        --color-primary: #007aff;
        --color-primary-hover: #0056cc;
        --color-primary-active: #004499;
        --color-success: #34c759;
        --color-error: #ff3b30;
        --color-warning: #ff9500;

        --color-bg-primary: #ffffff;
        --color-bg-secondary: #f8f8f8;
        --color-bg-tertiary: #f0f0f0;
        --color-bg-sidebar: #f5f5f5;

        --color-border-primary: #e0e0e0;
        --color-border-secondary: #d0d0d0;
        --color-border-focus: #007aff;

        --color-text-primary: #333333;
        --color-text-secondary: #666666;
        --color-text-tertiary: #999999;
        --color-text-inverse: #ffffff;

        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;

        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;

        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.15);

        --font-size-xs: 11px;
        --font-size-sm: 12px;
        --font-size-md: 13px;
        --font-size-lg: 14px;
        --font-size-xl: 16px;
        --font-size-2xl: 18px;

        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;

        --transition-fast: 0.15s ease;
        --transition-normal: 0.2s ease;
        --transition-slow: 0.3s ease;
      }

      /* Base Styles */
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          "Segoe UI", "Roboto", sans-serif;
        font-size: var(--font-size-md);
        line-height: 1.4;
        color: var(--color-text-primary);
        background: rgba(255, 255, 255, 0.04);
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        height: 100vh;
      }

      /* Window Layout */
      .window {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.02);
        overflow-y: scroll;
      }

      /* Header */
      .toolbar-header {
        background: rgba(248, 248, 248, 0.25);
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        -webkit-app-region: drag;
        padding: 0 var(--spacing-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 44px;
        position: relative;
      }

      .toolbar-header .title {
        margin: 0;
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        text-align: center;
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .toolbar-actions {
        -webkit-app-region: no-drag;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: var(--spacing-xs);
      }

      /* Content Layout */
      .window-content {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: 220px;
        background: rgba(255, 255, 255, 0.02);
        border-right: 1px solid rgba(0, 0, 0, 0.08);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        position: relative;
        animation: sidebarFadeIn 0.3s ease-out;
      }

      @keyframes sidebarFadeIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .sidebar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        pointer-events: none;
        z-index: 1;
      }

      .sidebar > * {
        position: relative;
        z-index: 2;
      }

      .nav-group {
        padding: var(--spacing-sm) 0;
        margin: 0;
      }

      .nav-group-item {
        display: flex;
        align-items: center;
        padding: 8px var(--spacing-lg);
        color: var(--color-text-primary);
        text-decoration: none;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        cursor: pointer;
        transition: all var(--transition-normal);
        position: relative;
        margin: 2px var(--spacing-sm);
        border-radius: var(--radius-md);
        background: transparent;
      }

      .nav-group-item:hover {
        background: rgba(0, 122, 255, 0.08);
        color: var(--color-primary);
        transform: translateX(2px);
      }

      .nav-group-item.active {
        background: rgba(0, 122, 255, 0.15);
        color: var(--color-primary);
        box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.2);
        font-weight: var(--font-weight-semibold);
      }

      .nav-group-item.active .icn {
        color: var(--color-primary);
      }

      .nav-group-item.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 20px;
        background: var(--color-primary);
        border-radius: 0 2px 2px 0;
        box-shadow: 0 0 4px rgba(0, 122, 255, 0.3);
      }

      .nav-group-item .icn {
        margin-right: var(--spacing-sm);
        width: 18px;
        height: 18px;
        font-size: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all var(--transition-normal);
        opacity: 0.8;
      }

      .nav-group-item:hover .icn {
        opacity: 1;
        transform: scale(1.05);
      }

      .nav-group-item.active .icn {
        opacity: 1;
        transform: scale(1.1);
      }

      /* Phosphor icon styling */
      .ph-duotone {
        vertical-align: middle;
        flex-shrink: 0;
      }

      .btn .ph-duotone {
        margin-right: var(--spacing-xs);
        font-size: var(--font-size-sm);
      }

      /* Action buttons styling */
      .action-btn {
        cursor: pointer !important;
        display: grid !important;
        place-items: center !important;
        background: var(--color-bg-primary) !important;
      }

      .action-btn .ph {
        margin-right: var(--spacing-xs);
        font-size: var(--font-size-sm);
      }

      /* Main Content */
      .settings-content {
        flex: 1;
        padding: var(--spacing-xl);
        overflow-y: auto;
        background: var(--color-bg-primary);
        border-left: 1px solid var(--color-border-primary);
      }

      .settings-section {
        margin-bottom: var(--spacing-xl);
      }

      /* Section Headers */
      .section-header {
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--color-border-primary);
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }

      .section-header .ph-duotone {
        margin-top: 2px;
        font-size: 20px;
        color: var(--color-primary);
        flex-shrink: 0;
      }

      .section-title {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-xs) 0;
        line-height: 1.2;
      }

      .section-description {
        font-size: var(--font-size-md);
        color: var(--color-text-secondary);
        margin: 0;
        line-height: 1.4;
      }

      /* Form Groups */
      .form-group {
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-sm);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
      }

      .form-group:hover {
        border-color: var(--color-border-secondary);
        box-shadow: var(--shadow-sm);
      }

      .form-group.has-error {
        border-color: var(--color-error);
        background: rgba(255, 59, 48, 0.02);
      }

      .form-group label {
        display: flex;
        align-items: center;
        font-size: var(--font-size-md);
        font-weight: var(--font-weight-medium);
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-sm);
        line-height: 1.3;
      }

      .form-group label .ph-duotone {
        margin-right: var(--spacing-sm);
        font-size: var(--font-size-lg);
        color: var(--color-text-secondary);
        flex-shrink: 0;
      }

      .form-group .field-description {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-sm);
        line-height: 1.4;
      }

      /* Form Controls */
      .form-control {
        width: 100%;
        max-width: 400px;
        padding: 6px 10px;
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-md);
        background: rgba(255, 255, 255, 0.08);
        transition: all var(--transition-fast);
        font-family: inherit;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--color-border-focus);
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
      }

      .form-control:disabled {
        background: rgba(255, 255, 255, 0.06);
        color: var(--color-text-tertiary);
        cursor: not-allowed;
      }

      /* Directory Input */
      .directory-container {
        display: flex;
        gap: var(--spacing-sm);
        max-width: 400px;
      }

      .directory-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.06);
        cursor: not-allowed;
      }

      .directory-browse-btn {
        flex-shrink: 0;
        min-width: 80px;
      }

      /* Hotkey Input */
      .hotkey-container {
        display: flex;
        gap: var(--spacing-sm);
        max-width: 400px;
        align-items: center;
      }

      .hotkey-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.06);
        cursor: pointer;
        font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", monospace;
        font-size: var(--font-size-sm);
        text-align: center;
        transition: var(--transition-fast);
      }

      .hotkey-input:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      .hotkey-input:focus {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
      }

      .hotkey-input::placeholder {
        color: var(--color-text-tertiary);
        font-style: italic;
      }

      .hotkey-clear-btn {
        flex-shrink: 0;
        min-width: 32px;
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
      }

      .hotkey-clear-btn i {
        font-size: 14px;
      }

      /* Textarea */
      .form-control textarea {
        min-height: 80px;
        resize: vertical;
        font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono",
          monospace;
        line-height: 1.5;
      }

      /* Slider */
      .slider-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        max-width: 400px;
      }

      .slider {
        flex: 1;
        appearance: none;
        -webkit-appearance: none;
        height: 4px;
        border-radius: 2px;
        background: var(--color-border-primary);
        outline: none;
        transition: all var(--transition-fast);
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--color-primary);
        cursor: pointer;
        transition: all var(--transition-fast);
        box-shadow: var(--shadow-sm);
      }

      .slider::-webkit-slider-thumb:hover {
        background: var(--color-primary-hover);
        transform: scale(1.1);
      }

      .slider-value {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        min-width: 60px;
        text-align: right;
        font-family: "SF Mono", Monaco, monospace;
        font-weight: var(--font-weight-medium);
      }

      /* Checkbox */
      .checkbox-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) 0;
      }

      .checkbox-container label {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin: 0;
        font-weight: var(--font-weight-medium);
      }

      .checkbox {
        width: 18px;
        height: 18px;
        min-width: 18px;
        border: 2px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        appearance: none;
        background: rgba(255, 255, 255, 0.08);
        cursor: pointer;
        position: relative;
        transition: all var(--transition-fast);
        margin: 0;
      }

      .checkbox:checked {
        background: var(--color-primary);
        border-color: var(--color-primary);
      }

      .checkbox:checked::after {
        content: "âœ“";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: var(--font-size-sm);
        color: var(--color-text-inverse);
        font-weight: var(--font-weight-bold);
      }

      .checkbox:hover {
        border-color: var(--color-border-focus);
      }

      /* Buttons */
      .btn {
        padding: 6px 12px;
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.08);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        min-height: 28px;
        text-decoration: none;
        color: var(--color-text-primary);
      }

      .btn-icn-only {
        padding: 6px;
        min-width: 28px;
        width: 28px;
        height: 28px;
      }

      .btn-icn-only .ph-duotone {
        margin: 0;
        font-size: 14px;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: var(--color-border-secondary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .btn-primary {
        background: var(--color-primary);
        color: var(--color-text-inverse);
        border-color: var(--color-primary);
      }

      .btn-primary:hover {
        background: var(--color-primary-hover);
        border-color: var(--color-primary-hover);
      }

      .btn-negative {
        background: var(--color-error);
        color: var(--color-text-inverse);
        border-color: var(--color-error);
      }

      .btn-negative:hover {
        background: #d70015;
        border-color: #d70015;
      }

      /* Form Actions */
      .form-actions {
        display: flex;
        gap: var(--spacing-sm);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--color-border-primary);
        margin-top: var(--spacing-xl);
        background: rgba(255, 255, 255, 0.06);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin: var(--spacing-xl) 0 0 0;
      }

      /* Status Messages */
      .status-message {
        position: fixed;
        top: 60px;
        right: 20px;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        opacity: 0;
        transform: translateY(-10px);
        transition: all var(--transition-slow);
        z-index: 1000;
        box-shadow: var(--shadow-lg);
      }

      /* Small spinner used in buttons */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.6);
        border-top-color: #fff;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        vertical-align: -2px;
        animation: spin 0.9s linear infinite;
      }

      .status-message.show {
        opacity: 1;
        transform: translateY(0);
      }

      .status-message.success {
        background: var(--color-success);
        color: var(--color-text-inverse);
      }
      .status-message.info {
        background-color: var(--color-primary);
        color: var(--color-text-inverse);
      }

      .status-message.error {
        background: var(--color-error);
        color: var(--color-text-inverse);
      }

      /* Validation */
      .validation-error {
        color: var(--color-error);
        font-size: var(--font-size-sm);
        margin-top: var(--spacing-xs);
      }

      .form-group.has-error .form-control {
        border-color: var(--color-error);
      }

      .form-group.has-error .form-control:focus {
        box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.2);
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--color-bg-tertiary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--color-border-secondary);
        border-radius: var(--radius-sm);
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--color-text-tertiary);
      }

      /* Subtle micro-interactions */
      .nav-group-item {
        position: relative;
      }

      .form-group {
        position: relative;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .sidebar {
          width: 180px;
        }

        .settings-content {
          padding: var(--spacing-md);
        }

        .form-actions {
          flex-direction: column;
        }
      }

      /* Plugin Options Styles */
      .plugin-options-section {
        margin-top: var(--spacing-md);
      }

      .plugin-config-section {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-lg);
        background: var(--color-bg-secondary);
        transition: var(--transition-fast);
      }

      .plugin-config-section:hover {
        border-color: var(--color-border-secondary);
      }

      .plugin-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-md);
      }

      .plugin-info h4 {
        margin: 0 0 var(--spacing-xs) 0;
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
      }

      .plugin-description {
        margin: 0;
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
      }

      .plugin-delete-btn {
        background: var(--color-error);
        color: var(--color-text-inverse);
        border: none;
        border-radius: var(--radius-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-size-xs);
        cursor: pointer;
        transition: var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .plugin-delete-btn:hover {
        background: #d32f2f;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .plugin-option {
        margin-bottom: var(--spacing-md);
      }

      .plugin-option:last-child {
        margin-bottom: 0;
      }

      /* Data Management Styles */
      .data-management-section {
        margin-top: var(--spacing-lg);
      }

      .total-data-usage-summary {
        background: linear-gradient(
          135deg,
          rgba(0, 122, 255, 0.08),
          rgba(0, 122, 255, 0.03)
        );
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
      }

      .usage-stats {
        display: flex;
        gap: var(--spacing-xl);
        flex-wrap: wrap;
      }

      .usage-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .usage-label {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
      }

      .usage-value {
        color: var(--color-text-primary);
        font-weight: var(--font-weight-semibold);
        font-size: var(--font-size-md);
      }

      .plugin-data-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .plugin-data-item {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-md);
        background: transparent;
        transition: all var(--transition-fast);
      }

      .plugin-data-item:hover {
        border-color: var(--color-border-secondary);
        box-shadow: var(--shadow-sm);
      }

      .plugin-data-item.active {
        border-color: var(--color-primary);
        background: rgba(0, 122, 255, 0.05);
      }

      .plugin-data-info {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: var(--spacing-sm);
      }

      .plugin-data-info-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .plugin-name {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .active-badge {
        background: var(--color-success);
        color: var(--color-text-inverse);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
      }

      .plugin-data-details-summary {
        display: flex;
        gap: var(--spacing-md);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
      }

      .data-size,
      .data-path {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .plugin-data-actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        align-self: flex-end;
      }

      .btn-sm {
        padding: 4px 8px;
        font-size: var(--font-size-xs);
        min-height: 24px;
      }
      .btn-xs {
        padding: 2px 6px;
        font-size: var(--font-size-xs);
        min-height: 20px;
      }

      .active-plugin-note {
        font-size: var(--font-size-sm);
        color: var(--color-text-tertiary);
        font-style: italic;
      }

      .loading-indicator,
      .error-message,
      .no-data-message {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xl);
        color: var(--color-text-secondary);
        font-size: var(--font-size-md);
        gap: var(--spacing-sm);
      }

      .error-message {
        color: var(--color-error);
      }

      .no-data-message {
        color: var(--color-text-tertiary);
      }

      /* Enhanced Data Management Styles */
      .plugin-data-stats {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        font-size: var(--font-size-xs);
        color: var(--color-text-secondary);
      }

      .plugin-data-actions {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .plugin-details-btn {
        background: var(--color-bg-tertiary);
        color: var(--color-text-primary);
        border: 1px solid var(--color-border-primary);
      }

      .plugin-details-btn:hover {
        background: var(--color-bg-secondary);
        border-color: var(--color-border-secondary);
      }

      .plugin-data-details {
        margin-top: var(--spacing-sm);
      }

      .plugin-data-details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
        padding-bottom: var(--spacing-xs);
        border-bottom: 1px solid var(--color-border-secondary);
      }

      .plugin-data-details-header h6 {
        margin: 0;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
      }

      .item-count {
        font-size: var(--font-size-xs);
        color: var(--color-text-tertiary);
        background: var(--color-bg-secondary);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        font-weight: var(--font-weight-medium);
      }

      .refresh-btn {
        transition: all var(--transition-fast);
      }

      .refresh-btn:hover i {
        transform: rotate(180deg);
        transition: transform var(--transition-fast);
      }

      .refresh-btn:active i {
        transform: rotate(360deg);
      }

      .plugin-data-items {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .plugin-data-item-detail {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-xs) var(--spacing-sm);
        transition: all var(--transition-fast);
        margin-bottom: var(--spacing-xs);
      }

      .plugin-data-item-detail:last-child {
        margin-bottom: 0;
      }

      .plugin-data-item-detail:hover {
        background: rgba(0, 122, 255, 0.05);
      }

      .item-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 1;
      }

      .item-name {
        font-weight: var(--font-weight-medium);
        color: var(--color-text-primary);
        cursor: help;
      }

      .item-size {
        font-size: var(--font-size-xs);
        color: var(--color-text-tertiary);
        font-family: monospace;
      }

      .item-actions {
        margin-left: var(--spacing-md);
      }

      .delete-item-btn {
        background: none;
        color: var(--color-text-secondary);
        border: none;
        font-size: var(--font-size-xs);
        padding: var(--spacing-xs);
        transition: all var(--transition-fast);
      }

      .delete-item-btn:hover {
        background: var(--color-error);
        color: var(--color-text-inverse);
        border-radius: var(--radius-sm);
      }

      .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--color-text-secondary);
      }

      .empty-state i {
        font-size: 24px;
        margin-bottom: var(--spacing-sm);
        opacity: 0.5;
      }

      /* Actions Editor Styles */
      .actions-editor-container {
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-lg);
        background: var(--color-bg-secondary);
        overflow: hidden;
      }

      .actions-editor-toolbar {
        padding: var(--spacing-md);
        background: rgba(0, 122, 255, 0.05);
        border-bottom: 1px solid var(--color-border-primary);
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .actions-list {
        max-height: 600px;
        overflow-y: auto;
      }

      .empty-actions-state {
        padding: var(--spacing-xl);
        text-align: center;
        color: var(--color-text-secondary);
      }

      .empty-actions-state i {
        font-size: 48px;
        opacity: 0.5;
        margin-bottom: var(--spacing-md);
      }

      .empty-actions-state p {
        margin: 0;
        font-size: var(--font-size-md);
      }

      .empty-subtitle {
        font-size: var(--font-size-sm) !important;
        opacity: 0.7;
        margin-top: var(--spacing-xs) !important;
      }

      .action-card {
        border-bottom: 1px solid var(--color-border-primary);
        background: var(--color-bg-primary);
        transition: all var(--transition-fast);
      }

      .action-card:hover {
        background: rgba(0, 122, 255, 0.02);
      }

      .action-card-header {
        padding: var(--spacing-md);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        cursor: pointer;
      }

      .action-info {
        flex: 1;
      }

      .action-toggle {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
      }

      .action-enabled-checkbox {
        margin: 0;
      }

      .action-name {
        margin: 0;
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
      }

      .transformation-header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-md);
        flex-wrap: wrap;
      }

      .transformation-enabled-toggles {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
      }

      .transformation-enabled-toggles .checkbox-label {
        margin: 0;
        font-weight: var(--font-weight-medium);
      }

      .transformation-description {
        margin-bottom: 0;
      }

      .transformation-hint {
        margin-top: var(--spacing-md);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
      }

      .action-description {
        margin: 0;
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        line-height: 1.4;
      }

      .action-controls {
        display: flex;
        gap: var(--spacing-xs);
        align-items: flex-start;
      }

      .action-card-body {
        border-top: 1px solid var(--color-border-primary);
        background: rgba(0, 0, 0, 0.02);
        transition: all var(--transition-normal);
        overflow: hidden;
      }

      .action-card-body.collapsed {
        max-height: 0;
        padding: 0 var(--spacing-md);
        border-top-color: transparent;
      }

      .action-card-body:not(.collapsed) {
        padding: var(--spacing-md);
        max-height: 1000px;
      }

      .action-form-group {
        margin-bottom: var(--spacing-md);
      }

      .action-form-group label {
        display: block;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .action-form-group .form-control {
        width: 100%;
        max-width: none;
      }

      .action-form-row {
        display: flex;
        gap: var(--spacing-md);
        align-items: end;
      }

      .action-form-col {
        flex: 1;
        min-width: 0;
      }

      .action-form-col .checkbox-label {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-size-sm);
        color: var(--color-text-primary);
        margin-bottom: 0;
        cursor: pointer;
      }

      .action-form-col .checkbox-label input[type="checkbox"] {
        margin: 0;
      }

      .section-header-small {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: var(--spacing-lg) 0 var(--spacing-md) 0;
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--color-border-primary);
      }

      .section-header-small h5 {
        margin: 0;
        font-size: var(--font-size-md);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
      }

      .header-actions {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .patterns-list,
      .handlers-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .pattern-item,
      .handler-item {
        padding: var(--spacing-md);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-md);
        background: var(--color-bg-primary);
      }

      .pattern-controls {
        display: grid;
        grid-template-columns: 140px 1fr auto auto;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .case-sensitive-label {
        display: flex !important;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-size-sm) !important;
        margin: 0 !important;
        white-space: nowrap;
      }

      .case-sensitive-label input {
        margin: 0;
      }

      .handler-header {
        display: grid;
        grid-template-columns: 1fr 80px auto;
        gap: var(--spacing-sm);
        align-items: center;
        margin-bottom: var(--spacing-md);
      }

      .handler-config {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .config-field {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .config-field label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--color-text-secondary);
        margin: 0;
      }

      .config-field input[type="checkbox"] {
        margin-right: var(--spacing-xs);
      }

      .field-help {
        font-size: var(--font-size-xs);
        color: var(--color-text-tertiary);
        font-style: italic;
        margin-top: var(--spacing-xs);
      }

      .handler-order-input {
        width: 60px;
        text-align: center;
      }

      /* Rules Editor Styles */
      .rules-editor-container {
        overflow: hidden;
      }

      .rules-editor-toolbar {
        padding: var(--spacing-md);
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .rules-list {
        max-height: 600px;
        overflow-y: auto;
      }

      .empty-rules-state {
        padding: var(--spacing-xl);
        text-align: center;
        color: var(--color-text-secondary);
      }

      .empty-rules-state i {
        font-size: 48px;
        opacity: 0.5;
        margin-bottom: var(--spacing-md);
      }

      .empty-rules-state p {
        margin: 0;
        font-size: var(--font-size-md);
      }

      .rule-card {
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-md);
        background: var(--color-bg-primary);
        transition: all var(--transition-fast);
        margin-bottom: var(--spacing-sm);
        box-shadow: var(--shadow-sm);
      }

      .rule-card:hover {
        background: rgba(0, 122, 255, 0.02);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .rule-card.expanded {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 1px var(--color-primary);
      }

      .rule-card-header {
        padding: var(--spacing-sm) var(--spacing-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        min-height: 48px;
        position: relative;
      }



      .rule-info {
        flex: 1;
        overflow: hidden;
      }

      .rule-toggle {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 1;
        min-width: 0;
      }

      .rule-enabled-checkbox {
        margin: 0;
      }

      .rule-name {
        margin: 0;
        font-size: var(--font-size-md);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px;
      }

      .rule-description {
        margin: 0;
        font-size: var(--font-size-xs);
        color: var(--color-text-tertiary);
        line-height: 1.3;
        margin-left: 28px;
      }

      .rule-controls {
        display: flex;
        gap: var(--spacing-xs);
        align-items: center;
        flex-shrink: 0;
      }

      .rule-card-body {
        border-top: 1px solid var(--color-border-primary);
        background: rgba(0, 0, 0, 0.02);
        transition: all var(--transition-normal);
        overflow: hidden;
        transform-origin: top;
      }

      .rule-card-body.collapsed {
        max-height: 0;
        padding: 0;
        border-top-color: transparent;
      }

      .rule-card-body:not(.collapsed) {
        padding: var(--spacing-md);
        max-height: 1000px;
      }

      .rule-form-group {
        margin-bottom: var(--spacing-sm);
      }

      .rule-form-group label {
        display: block;
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .rule-form-group .form-control {
        width: 100%;
        max-width: none;
      }

      .conditions-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
      }

      .condition-checkbox {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-size-xs);
        color: var(--color-text-secondary);
        margin: 0;
        cursor: pointer;
        padding: var(--spacing-xs) var(--spacing-sm);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        background: var(--color-bg-primary);
        transition: all var(--transition-fast);
      }

      .condition-checkbox:hover {
        background: rgba(0, 122, 255, 0.05);
        border-color: var(--color-primary);
      }

      .condition-checkbox input[type="checkbox"] {
        display: none;
      }

      .condition-checkbox.active {
        background: rgba(0, 122, 255, 0.1);
        border-color: var(--color-primary);
        color: var(--color-primary);
      }

      .examples-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .example-item {
        padding: var(--spacing-sm);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        background: var(--color-bg-primary);
        position: relative;
      }

      .example-controls {
        display: flex;
        gap: var(--spacing-xs);
        align-items: flex-start;
      }

      .example-inputs {
        flex: 1;
        display: flex;
        gap: var(--spacing-xs);
        align-items: center;
      }

      .example-inputs i {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
      }

      .btn-sm {
        padding: 4px 6px;
        font-size: var(--font-size-xs);
        min-width: 90px;
        height: 24px;
      }

      .btn-icn-only.btn-sm {
        width: 24px;
        height: 24px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rule-enabled-checkbox {
        margin: 0;
        transform: scale(0.9);
      }

      .rule-move-btn {
        cursor: pointer;
        padding: var(--spacing-xs);
        color: var(--color-text-secondary);
        transition: color var(--transition-fast);
        border-radius: var(--radius-sm);
      }

      .rule-move-btn:hover:not(.disabled) {
        color: var(--color-primary);
        background: rgba(0, 122, 255, 0.1);
      }

      .rule-move-btn.disabled {
        color: var(--color-text-tertiary);
        cursor: not-allowed;
        opacity: 0.5;
      }

      .condition-tag {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .condition-tag i {
        font-size: var(--font-size-xs);
      }

      .example-inputs {
        flex: 1;
        display: flex;
        gap: var(--spacing-md);
        align-items: flex-start;
      }

      .example-column {
        flex: 1;
      }

      .example-column label {
        display: block;
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .example-textarea {
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: var(--font-size-xs);
        line-height: 1.4;
        resize: vertical;
        min-height: 80px;
      }

      .example-delete-btn {
        position: absolute;
        top: var(--spacing-xs);
        right: var(--spacing-xs);
        z-index: 1;
      }

      .progress-overlay {
        position: fixed;
        top: 60px;
        right: 20px;
        background: rgba(0, 122, 255, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001;
        min-width: 280px;
        font-size: 13px;
        opacity: 0;
        transform: translateY(-10px);
        transition: all var(--transition-slow);
      }

      .progress-overlay.show {
        opacity: 1;
        transform: translateY(0);
      }

      .progress-bar-container {
        background: rgba(255, 255, 255, 0.2);
        height: 4px;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-bar-fill {
        background: white;
        height: 100%;
        transition: width 0.3s ease;
      }

      /* Permissions Section Styles */
      .form-group.permission-granted {
        border-color: var(--color-success);
        background: rgba(52, 199, 89, 0.03);
      }

      .permission-status-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
        flex-wrap: wrap;
      }

      .status-badge {
        padding: 3px 8px;
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-badge.granted {
        background: rgba(52, 199, 89, 0.15);
        color: var(--color-success);
      }

      .status-badge.denied {
        background: rgba(255, 59, 48, 0.15);
        color: var(--color-error);
      }

      .status-badge.unknown {
        background: rgba(255, 149, 0, 0.15);
        color: var(--color-warning);
      }

      .status-error {
        font-size: var(--font-size-sm);
        color: var(--color-error);
        font-style: italic;
      }

      .permission-actions {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
      }

      .form-group.info-group {
        background: rgba(0, 122, 255, 0.03);
        border-color: rgba(0, 122, 255, 0.1);
      }

      .form-group.info-group .field-description p {
        margin: 0 0 var(--spacing-xs) 0;
        line-height: 1.4;
      }

      .form-group.info-group .field-description p:last-child {
        margin-bottom: 0;
      }

      .spinning {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      /* About Section Styles */
      .about-content {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xl);
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.03), rgba(0, 122, 255, 0.01));
      }

      .about-container {
        max-width: 500px;
        width: 100%;
        text-align: center;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(10px);
        transition: all var(--transition-normal);
      }

      .about-container:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-1px);
      }

      .about-header {
        margin-bottom: var(--spacing-xl);
      }

      .about-app-icon {
        width: 80px;
        height: 80px;
        border-radius: var(--radius-lg);
        margin: 0 auto var(--spacing-lg);
        transition: all var(--transition-normal);
      }

      .about-app-icon:hover {
        transform: scale(1.02);
        filter: brightness(1.1);
      }

      .about-app-name {
        font-size: 28px;
        font-weight: 300;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-sm);
        letter-spacing: -0.5px;
        transition: color var(--transition-normal);
      }

      .about-app-name:hover {
        color: var(--color-primary);
      }

      .about-app-version {
        font-size: var(--font-size-lg);
        color: var(--color-primary);
        font-weight: var(--font-weight-medium);
        margin: 0 0 var(--spacing-md);
        text-decoration: none;
        transition: all var(--transition-normal);
        display: inline-block;
      }

      .about-app-version:hover {
        color: var(--color-primary-hover);
        transform: translateY(-1px);
      }

      .about-app-description {
        font-size: var(--font-size-md);
        color: var(--color-text-secondary);
        line-height: 1.5;
        margin: 0 0 var(--spacing-sm);
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        transition: color var(--transition-normal);
      }

      .about-app-description:hover {
        color: var(--color-text-primary);
      }

      .about-app-author {
        font-size: var(--font-size-sm);
        color: var(--color-text-tertiary);
        margin: 0;
        font-style: italic;
        text-decoration: none;
        transition: all var(--transition-normal);
        display: inline-block;
      }

      .about-app-author:hover {
        color: var(--color-primary);
        transform: translateY(-1px);
      }

      .about-actions {
        display: flex;
        gap: var(--spacing-sm);
        justify-content: center;
        margin-bottom: var(--spacing-lg);
      }

      .about-action-btn {
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        min-width: 100px;
        background: rgba(255, 255, 255, 0.9);
        color: var(--color-text-primary);
        border: 1px solid var(--color-border-primary);
        transition: all var(--transition-normal);
      }

      .about-action-btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .about-action-btn:active {
        transform: translateY(0);
      }

      .about-footer {
        border-top: 1px solid var(--color-border-primary);
        padding-top: var(--spacing-lg);
        transition: border-color var(--transition-normal);
      }

      .about-footer:hover {
        border-top-color: var(--color-primary);
      }

      .about-footer-text {
        font-size: var(--font-size-sm);
        color: var(--color-text-tertiary);
        margin: 0;
        line-height: 1.4;
        transition: color var(--transition-normal);
      }

      .about-footer:hover .about-footer-text {
        color: var(--color-text-secondary);
      }

      .about-footer-details {
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--color-border-primary);
      }

      .about-footer-link {
        color: var(--color-primary);
        text-decoration: none;
        transition: all var(--transition-normal);
      }

      .about-footer-link:hover {
        color: var(--color-primary-hover);
        text-decoration: underline;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Dark mode */
      @media (prefers-color-scheme: dark) {
        :root {
          --color-bg-primary: #0b0b0c;
          --color-bg-secondary: rgba(30, 30, 33, 0.4);
          --color-bg-tertiary: rgba(22, 22, 24, 0.6);
          --color-bg-sidebar: rgba(30, 30, 33, 0.28);

          --color-border-primary: rgba(255, 255, 255, 0.12);
          --color-border-secondary: rgba(255, 255, 255, 0.18);
          --color-border-focus: #007aff;

          --color-text-primary: #ececec;
          --color-text-secondary: #a2a2a7;
          --color-text-tertiary: #666666;
          --color-text-inverse: #ffffff;
        }

        body {
          color-scheme: dark;
          color: var(--color-text-primary);
          background: rgba(0, 0, 0, 0.04);
        }

        .window {
          background: rgba(0, 0, 0, 0.02);
        }

        .toolbar-header {
          background: rgba(30, 30, 33, 0.25);
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar {
          background: rgba(30, 30, 33, 0.28);
          border-right: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-group-item {
          color: var(--color-text-primary);
        }

        .nav-group-item:hover {
          background: rgba(0, 122, 255, 0.12);
        }

        .nav-group-item.active {
          background: rgba(0, 122, 255, 0.2);
        }

        .settings-content {
          background: var(--color-bg-primary);
          border-left: 1px solid var(--color-border-primary);
        }

        .form-group {
          background: rgba(255, 255, 255, 0.02);
        }

        .form-group:hover {
          background: rgba(255, 255, 255, 0.04);
        }

        .form-control {
          background: rgba(255, 255, 255, 0.06);
          color: var(--color-text-primary);
          border-color: var(--color-border-primary);
        }

        .form-control:focus {
          border-color: var(--color-border-focus);
        }

        .form-control:disabled {
          background: rgba(255, 255, 255, 0.03);
          color: var(--color-text-tertiary);
        }

        .btn {
          background: rgba(255, 255, 255, 0.06);
          color: var(--color-text-primary);
          border-color: var(--color-border-primary);
        }

        .btn:hover {
          background: rgba(255, 255, 255, 0.12);
          border-color: var(--color-border-secondary);
        }

        .checkbox {
          background: rgba(255, 255, 255, 0.06);
          border-color: var(--color-border-primary);
        }

        .checkbox:checked {
          background: var(--color-primary);
          border-color: var(--color-primary);
        }

        .checkbox:hover {
          border-color: var(--color-border-focus);
        }

        .total-data-usage-summary {
          background: linear-gradient(
            135deg,
            rgba(0, 122, 255, 0.12),
            rgba(0, 122, 255, 0.06)
          );
          border-color: var(--color-border-primary);
        }

        .plugin-config-section {
          background: rgba(255, 255, 255, 0.04);
          border-color: var(--color-border-primary);
        }

        .plugin-data-item {
          background: rgba(255, 255, 255, 0.02);
          border-color: var(--color-border-primary);
        }

        .plugin-data-item:hover {
          background: rgba(255, 255, 255, 0.04);
        }

        .plugin-data-item.active {
          background: rgba(0, 122, 255, 0.08);
        }

        .plugin-data-item-detail:hover {
          background: rgba(0, 122, 255, 0.08);
        }

        .actions-editor-container {
          background: var(--color-bg-secondary);
          border-color: var(--color-border-primary);
        }

        .actions-editor-toolbar {
          background: rgba(0, 122, 255, 0.08);
          border-bottom-color: var(--color-border-primary);
        }

        .action-card {
          background: var(--color-bg-primary);
          border-bottom-color: var(--color-border-primary);
        }

        .action-card:hover {
          background: rgba(0, 122, 255, 0.04);
        }

        .action-card-body {
          background: rgba(0, 0, 0, 0.1);
          border-top-color: var(--color-border-primary);
        }

        .pattern-item,
        .handler-item {
          background: var(--color-bg-primary);
          border-color: var(--color-border-primary);
        }

        .form-actions {
          background: rgba(255, 255, 255, 0.02);
        }

        .slider {
          background: var(--color-border-primary);
        }

        .item-count {
          background: var(--color-bg-secondary);
        }

        .plugin-details-btn {
          background: var(--color-bg-tertiary);
          border-color: var(--color-border-primary);
        }

        .plugin-details-btn:hover {
          background: var(--color-bg-secondary);
          border-color: var(--color-border-secondary);
        }

        ::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.2);
        }

        ::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.3);
        }

        .about-content {
          background: linear-gradient(135deg, rgba(0, 122, 255, 0.08), rgba(0, 122, 255, 0.04));
        }

        .about-container {
          background: rgba(255, 255, 255, 0.5);
          border-color: var(--color-border-primary);
        }

        .about-action-btn {
          background: rgba(255, 255, 255, 0.1);
          color: var(--color-text-primary);
          border-color: var(--color-border-primary);
        }

        .about-action-btn:hover {
          background: rgba(255, 255, 255, 0.15);
        }

        .about-footer-details {
          border-top-color: var(--color-border-primary);
        }

        .about-footer-link {
          color: var(--color-primary);
        }

        .about-footer-link:hover {
          color: var(--color-primary-hover);
        }
      }

      /* Permissions Custom Content */
      .permissions-custom-content {
        padding: var(--spacing-md);
        max-width: 100%;
        margin: 0 auto;
        background: var(--color-surface);
        border-radius: var(--border-radius-lg);
        border: 1px solid var(--color-border);
      }

      .permissions-section {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
      }

      .permissions-custom-content .section-header {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--color-border);
      }

      .permissions-custom-content .section-header i {
        font-size: var(--font-size-xl);
        color: var(--color-primary);
        margin-top: 2px;
      }

      .permissions-custom-content .section-title {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-xs) 0;
      }

      .permissions-custom-content .section-description {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        margin: 0;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div id="app" class="window" v-cloak>
      <header class="toolbar toolbar-header">
        <h1 class="title">Settings</h1>
        <div class="toolbar-actions">
          <button
            @click="resetAll"
            class="btn btn-default btn-icn-only action-btn"
            title="Reset all settings to defaults"
          >
            <i class="ph ph-arrow-clockwise"></i>
          </button>
          <button
            @click="importSettings"
            class="btn btn-default btn-icn-only action-btn"
            title="Import settings from file"
          >
            <i class="ph ph-download-simple"></i>
          </button>
          <button
            @click="exportSettings"
            class="btn btn-default btn-icn-only action-btn"
            title="Export settings to file"
          >
            <i class="ph ph-upload-simple"></i>
          </button>
        </div>
      </header>

      <div class="window-content" v-if="schema.length > 0">
        <nav class="sidebar">
          <div class="nav-group">
            <a
              v-for="section in schema"
              :key="section.id"
              class="nav-group-item"
              :class="{ active: currentSectionId === section.id }"
              @click="showSection(section.id)"
            >
              <i
                class="icn ph"
                :class="getIcon(section.icon || section.id)"
              ></i>
              {{ section.title }}
            </a>
            <a
              class="nav-group-item"
              :class="{ active: currentSectionId === 'about' }"
              @click="showSection('about')"
            >
              <i class="icn ph ph-info"></i>
              About
            </a>
          </div>
        </nav>

        <main class="settings-content" v-if="currentSection && settings">
          <form @submit.prevent="saveSettings">
            <div v-if="currentSectionId !== 'permissions'" class="settings-section">
              <div class="section-header">
                <i
                  class="ph-duotone"
                  :class="getIcon(currentSection.icon || currentSection.id)"
                ></i>
                <div>
                  <h2 class="section-title">{{ currentSection.title }}</h2>
                  <p
                    v-if="currentSection.description"
                    class="section-description"
                  >
                    {{ currentSection.description }}
                  </p>
                </div>
              </div>

              <!-- REGULAR FIELDS RENDERER -->
              <div
                v-if="currentSectionId !== 'permissions'"
                v-for="field in currentSection.fields"
                :key="field.key"
                class="form-group"
                :class="{ 'has-error': validationErrors[field.key] }"
              >
                <template
                  v-if="field.type !== 'boolean' && field.type !== 'actions-editor' && field.type !== 'rules-editor'"
                >
                  <label>
                    <i class="ph-duotone" :class="getFieldIcon(field)"></i>
                    {{ field.label }}
                  </label>
                </template>
                <div v-if="field.description" class="field-description">
                  {{ field.description }}
                </div>

                <!-- Field types -->
                <input
                  v-if="field.type === 'text' && field.key !== 'ai.baseUrl'"
                  type="text"
                  class="form-control"
                  :value="getSettingValue(field.key)"
                  @input="setSettingValue(field.key, $event.target.value)"
                  :placeholder="field.placeholder"
                />

                <template v-if="field.key === 'ai.baseUrl'">
                  <input
                    type="text"
                    class="form-control"
                    v-model="settings.ai.baseUrl"
                    @input="aiModelsState.loadedForBaseUrl = null"
                    :placeholder="field.placeholder"
                  />
                  <div class="form-group" style="margin-top: 8px">
                    <label for="aiApiKeyInline">
                      <i
                        class="ph-duotone ph-key"
                        style="margin-right: 6px; font-size: 14px"
                      ></i>
                      API Key (saved securely)
                      <span
                        v-if="aiModelsState.loading"
                        class="spinner"
                        style="
                          margin-left: 8px;
                          width: 12px;
                          height: 12px;
                          border-color: var(--color-text-secondary);
                          border-top-color: var(--color-primary);
                        "
                      ></span>
                    </label>
                    <input
                      type="password"
                      class="form-control"
                      id="aiApiKeyInline"
                      v-model="apiKeyInput"
                      @input="debouncedValidateApiKey"
                      placeholder="Paste API Key to validate & load models"
                    />
                  </div>
                </template>

                <template v-if="field.key === 'ai.model'">
                  <select
                    v-if="aiModelsState.loading"
                    class="form-control"
                    disabled
                  >
                    <option>Loading models...</option>
                  </select>
                  <select
                    v-else-if="aiModelsState.models.length > 0"
                    class="form-control"
                    v-model="settings.ai.model"
                  >
                    <option
                      v-for="model in aiModelsState.models"
                      :key="model.id"
                      :value="model.id"
                    >
                      {{ model.name || model.id }}
                    </option>
                  </select>
                  <input
                    v-else
                    type="text"
                    class="form-control"
                    v-model="settings.ai.model"
                    placeholder="Enter model name or validate API key"
                  />
                </template>

                <input
                  v-if="field.type === 'number'"
                  type="number"
                  class="form-control"
                  :value="getSettingValue(field.key)"
                  @input="setSettingValue(field.key, parseFloat($event.target.value))"
                  :min="field.min"
                  :max="field.max"
                  :step="field.step"
                />

                <div v-if="field.type === 'boolean'" class="checkbox-container">
                  <input
                    type="checkbox"
                    class="checkbox"
                    :id="'field-' + field.key"
                    :checked="getSettingValue(field.key)"
                    @change="setSettingValue(field.key, $event.target.checked)"
                  />
                  <label :for="'field-' + field.key">
                    <i class="ph-duotone" :class="getFieldIcon(field)"></i>
                    {{ field.label }}
                  </label>
                </div>

                <select
                  v-if="field.type === 'select' && field.key !== 'ai.model'"
                  class="form-control"
                  :value="getSettingValue(field.key)"
                  @change="setSettingValue(field.key, $event.target.value)"
                >
                  <option
                    v-for="option in field.options"
                    :key="option.value"
                    :value="option.value"
                  >
                    {{ option.label }}
                  </option>
                </select>

                <textarea
                  v-if="field.type === 'textarea'"
                  class="form-control"
                  rows="6"
                  :value="getSettingValue(field.key)"
                  @input="setSettingValue(field.key, $event.target.value)"
                  :placeholder="field.placeholder"
                ></textarea>

                <div v-if="field.type === 'slider'" class="slider-container">
                  <input
                    type="range"
                    class="slider"
                    :value="getSettingValue(field.key)"
                    @input="setSettingValue(field.key, parseFloat($event.target.value))"
                    :min="field.min"
                    :max="field.max"
                    :step="field.step"
                  />
                  <span class="slider-value"
                    >{{ getSettingValue(field.key) }}</span
                  >
                </div>

                <div
                  v-if="field.type === 'directory'"
                  class="directory-container"
                >
                  <input
                    type="text"
                    class="form-control directory-input"
                    :value="getSettingValue(field.key)"
                    readonly
                  />
                  <button
                    type="button"
                    @click="browseDirectory(field.key)"
                    class="btn btn-default directory-browse-btn"
                  >
                    <i class="ph-duotone ph-folder-open"></i> Browse
                  </button>
                </div>

                <!-- Hotkey Input -->
                <div
                  v-if="field.type === 'hotkey'"
                  class="hotkey-container"
                >
                  <input
                    type="text"
                    class="form-control hotkey-input"
                    :value="getSettingValue(field.key)"
                    @input="setSettingValue(field.key, $event.target.value)"
                    @keydown="captureHotkey($event, field.key)"
                    :placeholder="field.placeholder || 'Press keys to set hotkey'"
                    readonly
                  />
                  <button
                    type="button"
                    @click="clearHotkey(field.key)"
                    class="btn btn-default hotkey-clear-btn"
                    v-if="getSettingValue(field.key)"
                    title="Clear hotkey"
                  >
                    <i class="ph-duotone ph-x"></i>
                  </button>
                </div>

                <!-- Actions Editor -->
                <div v-if="field.type === 'actions-editor' && settings.actions">
                  <div class="actions-editor-container">
                    <div class="actions-editor-toolbar">
                      <button
                        @click="addNewAction"
                        type="button"
                        class="btn btn-primary btn-sm"
                      >
                        <i class="ph-duotone ph-plus"></i> Add Action
                      </button>
                      <button
                        @click="resetActionsToDefaults"
                        type="button"
                        class="btn btn-default btn-sm"
                      >
                        <i class="ph-duotone ph-arrow-clockwise"></i> Reset to
                        Defaults
                      </button>
                    </div>
                    <div class="actions-list">
                      <div
                        v-if="!settings.actions?.actions?.length"
                        class="empty-actions-state"
                      >
                        <i class="ph-duotone ph-lightning"></i>
                        <p>No actions configured</p>
                        <p class="empty-subtitle">
                          Add your first voice action to get started
                        </p>
                      </div>
                      <div
                        v-for="(action, index) in settings.actions?.actions || []"
                        :key="action.id"
                        class="action-card"
                      >
                        <div
                          class="action-card-header"
                          @click.self="toggleActionCard(action.id)"
                        >
                          <div class="action-info">
                            <div class="action-toggle">
                              <input
                                type="checkbox"
                                class="action-enabled-checkbox checkbox"
                                v-model="action.enabled"
                              />
                              <h4 class="action-name">{{ action.name }}</h4>
                            </div>
                            <p class="action-description">
                              {{ action.description }}
                            </p>
                          </div>
                          <div class="action-controls">
                            <button
                              type="button"
                              class="btn btn-icn-only"
                              @click="moveAction(index, -1)"
                              :disabled="index === 0"
                              title="Move up"
                            >
                              <i class="ph-duotone ph-caret-up"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-icn-only"
                              @click="moveAction(index, 1)"
                              :disabled="index === (settings.actions?.actions?.length || 0) - 1"
                              title="Move down"
                            >
                              <i class="ph-duotone ph-caret-down"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-icn-only"
                              @click="toggleActionCard(action.id)"
                              title="View action details"
                            >
                              <i class="ph-duotone ph-info"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-icn-only btn-negative"
                              @click="deleteAction(index)"
                              title="Delete action"
                            >
                              <i class="ph-duotone ph-trash"></i>
                            </button>
                          </div>
                        </div>
                        <div
                          class="action-card-body"
                          :class="{ collapsed: !expandedActions[action.id] }"
                        >
                          <div class="action-form-group">
                            <label>Action Name</label>
                            <input
                              type="text"
                              class="form-control"
                              v-model="action.name"
                            />
                          </div>
                          <div class="action-form-group">
                            <label>Description</label>
                            <input
                              type="text"
                              class="form-control"
                              v-model="action.description"
                            />
                          </div>
                          <div class="action-form-group action-form-row">
                            <div class="action-form-col">
                              <label>Order</label
                              ><input
                                type="number"
                                class="form-control"
                                v-model.number="action.order"
                                min="1"
                              />
                            </div>
                            <div class="action-form-col">
                              <label class="checkbox-label"
                                ><input
                                  type="checkbox"
                                  v-model="action.closesTranscription"
                                />
                                Closes Transcription</label
                              >
                            </div>
                            <div class="action-form-col">
                              <label class="checkbox-label"
                                ><input
                                  type="checkbox"
                                  v-model="action.skipsTransformation"
                                />
                                Skips Transformation</label
                              >
                            </div>
                          </div>
                          <div class="section-header-small">
                            <h5>Match Patterns</h5>
                            <button
                              type="button"
                              class="btn btn-sm"
                              @click="addNewPattern(index)"
                            >
                              <i class="ph-duotone ph-plus"></i> Add Pattern
                            </button>
                          </div>
                          <div class="patterns-list">
                            <div
                              v-for="(pattern, pIndex) in action.matchPatterns || []"
                              :key="pattern.id"
                              class="pattern-item"
                            >
                              <div class="pattern-controls">
                                <select
                                  class="form-control"
                                  v-model="pattern.type"
                                >
                                  <option value="startsWith">
                                    Starts with
                                  </option>
                                  <option value="endsWith">Ends with</option>
                                  <option value="exact">Exact match</option>
                                  <option value="regex">Regex</option>
                                </select>
                                <input
                                  type="text"
                                  class="form-control"
                                  placeholder="Pattern text..."
                                  v-model="pattern.pattern"
                                />
                                <label class="case-sensitive-label"
                                  ><input
                                    type="checkbox"
                                    v-model="pattern.caseSensitive"
                                  />
                                  Case sensitive</label
                                >
                                <button
                                  type="button"
                                  class="btn btn-icn-only btn-negative"
                                  @click="deletePattern(index, pIndex)"
                                >
                                  <i class="ph-duotone ph-x"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                          <div class="section-header-small">
                            <h5>Action Handlers</h5>
                            <button
                              type="button"
                              class="btn btn-sm"
                              @click="addNewHandler(index)"
                            >
                              <i class="ph-duotone ph-plus"></i> Add Handler
                            </button>
                          </div>
                          <div class="handlers-list">
                            <div
                              v-for="(handler, hIndex) in action.handlers || []"
                              :key="handler.id"
                              class="handler-item"
                            >
                              <div class="handler-header">
                                <select
                                  class="form-control"
                                  v-model="handler.type"
                                  @change="updateHandlerType(handler)"
                                >
                                  <option value="openUrl">Open URL</option>
                                  <option value="openApplication">
                                    Open Application
                                  </option>
                                  <option value="quitApplication">
                                    Quit Application
                                  </option>
                                  <option value="executeShell">
                                    Execute Shell
                                  </option>
                                  <option value="segmentAction">
                                    Segment Action
                                  </option>
                                </select>
                                <input
                                  type="number"
                                  class="form-control handler-order-input"
                                  v-model.number="handler.order"
                                  min="1"
                                  title="Execution order"
                                />
                                <button
                                  type="button"
                                  class="btn btn-icn-only btn-negative"
                                  @click="deleteHandler(index, hIndex)"
                                >
                                  <i class="ph-duotone ph-x"></i>
                                </button>
                              </div>
                              <div class="handler-config">
                                <template v-if="handler.type === 'openUrl'">
                                  <div class="config-field">
                                    <label>URL Template</label
                                    ><input
                                      type="text"
                                      class="form-control"
                                      placeholder="{argument}"
                                      v-model="handler.config.urlTemplate"
                                    />
                                  </div>
                                  <div class="config-field">
                                    <label
                                      ><input
                                        type="checkbox"
                                        v-model="handler.config.openInBackground"
                                      />
                                      Open in background</label
                                    >
                                  </div>
                                </template>
                                <template
                                  v-if="handler.type === 'openApplication'"
                                >
                                  <div class="config-field">
                                    <label>Application Name</label
                                    ><input
                                      type="text"
                                      class="form-control"
                                      placeholder="{argument}"
                                      v-model="handler.config.applicationName"
                                    />
                                  </div>
                                  <div class="config-field">
                                    <label
                                      ><input
                                        type="checkbox"
                                        v-model="handler.config.waitForExit"
                                      />
                                      Wait for exit</label
                                    >
                                  </div>
                                </template>
                                <template
                                  v-if="handler.type === 'quitApplication'"
                                >
                                  <div class="config-field">
                                    <label>Application Name</label
                                    ><input
                                      type="text"
                                      class="form-control"
                                      placeholder="{argument}"
                                      v-model="handler.config.applicationName"
                                    />
                                  </div>
                                  <div class="config-field">
                                    <label
                                      ><input
                                        type="checkbox"
                                        v-model="handler.config.forceQuit"
                                      />
                                      Force quit</label
                                    >
                                  </div>
                                </template>
                                <template
                                  v-if="handler.type === 'executeShell'"
                                >
                                  <div class="config-field">
                                    <label>Command</label
                                    ><textarea
                                      class="form-control"
                                      rows="3"
                                      v-model="handler.config.command"
                                    ></textarea>
                                  </div>
                                  <div class="config-field">
                                    <label>Working Directory</label
                                    ><input
                                      type="text"
                                      class="form-control"
                                      v-model="handler.config.workingDirectory"
                                    />
                                  </div>
                                  <div class="config-field">
                                    <label>Timeout (ms)</label
                                    ><input
                                      type="number"
                                      class="form-control"
                                      v-model.number="handler.config.timeout"
                                    />
                                  </div>
                                  <div class="config-field">
                                    <label
                                      ><input
                                        type="checkbox"
                                        v-model="handler.config.runInBackground"
                                      />
                                      Run in background</label
                                    >
                                  </div>
                                </template>
                                <template
                                  v-if="handler.type === 'segmentAction'"
                                >
                                  <div class="config-field">
                                    <label>Action</label>
                                    <select
                                      class="form-control"
                                      v-model="handler.config.action"
                                    >
                                      <option value="clear">Clear All</option>
                                      <option value="undo">Undo Last</option>
                                      <option value="replace">Replace</option>
                                      <option value="deleteLastN">
                                        Delete Last N
                                      </option>
                                      <option value="lowercaseFirstChar">
                                        Lowercase First Char
                                      </option>
                                      <option value="uppercaseFirstChar">
                                        Uppercase First Char
                                      </option>
                                      <option value="capitalizeFirstWord">
                                        Capitalize First Word
                                      </option>
                                      <option value="removePattern">
                                        Remove Pattern
                                      </option>
                                    </select>
                                  </div>
                                  <div
                                    v-if="handler.config.action === 'replace'"
                                    class="config-field"
                                  >
                                    <label>Replacement Text</label
                                    ><input
                                      type="text"
                                      class="form-control"
                                      placeholder="{argument}"
                                      v-model="handler.config.replacementText"
                                    />
                                  </div>
                                  <div
                                    v-if="handler.config.action === 'deleteLastN'"
                                    class="config-field"
                                  >
                                    <label>Count</label
                                    ><input
                                      type="number"
                                      class="form-control"
                                      min="1"
                                      v-model.number="handler.config.count"
                                    />
                                  </div>
                                  <div
                                    v-if="handler.config.action === 'removePattern'"
                                    class="config-field"
                                  >
                                    <label>Pattern to Remove</label
                                    ><input
                                      type="text"
                                      class="form-control"
                                      placeholder="\\.\\.\\."
                                      v-model="handler.config.pattern"
                                    />
                                  </div>
                                </template>
                              </div>
                              <div class="config-field" style="margin-top: 10px; border-top: 1px solid #e0e0e0; padding-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                  <input
                                    type="checkbox"
                                    v-model="handler.applyToNextSegment"
                                  />
                                  Apply to Next Segment
                                  <span style="font-size: 0.85em; color: #666; font-weight: normal;">
                                    (Queue this handler for the next segment instead of current)
                                  </span>
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Non-AI Transformations Editor -->
                <div
                  v-if="field.type === 'transformations-editor' && settings.nonAiTransformations"
                >
                  <div
                    class="actions-editor-container transformations-editor-container"
                  >
                    <div class="actions-editor-toolbar transformations-editor-toolbar">
                      <button
                        @click="addTransformationRule"
                        type="button"
                        class="btn btn-primary btn-sm"
                      >
                        <i class="ph-duotone ph-plus"></i> Add Rule
                      </button>
                      <button
                        @click="resetTransformationsToDefaults"
                        type="button"
                        class="btn btn-default btn-sm"
                      >
                        <i class="ph-duotone ph-arrow-clockwise"></i> Reset to
                        Defaults
                      </button>
                    </div>
                    <div class="actions-list transformations-list">
                      <div
                        v-if="!settings.nonAiTransformations?.rules?.length"
                        class="empty-actions-state empty-transformations-state"
                      >
                        <i class="ph-duotone ph-funnel-simple"></i>
                        <p>No non-AI transformations configured</p>
                        <p class="empty-subtitle">
                          Add regex-based cleanup rules that run before AI output
                        </p>
                      </div>
                      <div
                        v-for="(rule, index) in settings.nonAiTransformations?.rules || []"
                        :key="rule.id"
                        class="action-card transformation-card"
                      >
                        <div
                          class="action-card-header transformation-card-header"
                          @click.self="toggleTransformationCard(rule.id)"
                        >
                          <div class="action-info transformation-info">
                            <div class="transformation-header-row">
                              <h4 class="action-name transformation-name">
                                {{ rule.name || 'Untitled Rule' }}
                              </h4>
                              <div class="transformation-enabled-toggles">
                                <label class="checkbox-label">
                                  <input
                                    type="checkbox"
                                    v-model="rule.enabledForTranscription"
                                  />
                                  Transcription
                                </label>
                                <label class="checkbox-label">
                                  <input
                                    type="checkbox"
                                    v-model="rule.enabledForActions"
                                  />
                                  Actions
                                </label>
                              </div>
                            </div>
                            <p class="action-description transformation-description">
                              {{ rule.description || 'Runs when the pattern matches.' }}
                            </p>
                          </div>
                          <div class="action-controls transformation-controls">
                            <button
                              type="button"
                              class="btn btn-icn-only"
                              @click="moveTransformationRule(index, -1)"
                              :disabled="index === 0"
                              title="Move up"
                            >
                              <i class="ph-duotone ph-caret-up"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-icn-only"
                              @click="moveTransformationRule(index, 1)"
                              :disabled="index === (settings.nonAiTransformations?.rules?.length || 0) - 1"
                              title="Move down"
                            >
                              <i class="ph-duotone ph-caret-down"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-icn-only"
                              @click="toggleTransformationCard(rule.id)"
                              title="View rule details"
                            >
                              <i class="ph-duotone ph-info"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-icn-only btn-negative"
                              @click="deleteTransformationRule(index)"
                              title="Delete rule"
                            >
                              <i class="ph-duotone ph-trash"></i>
                            </button>
                          </div>
                        </div>
                        <div
                          class="action-card-body transformation-card-body"
                          :class="{ collapsed: !expandedTransformations[rule.id] }"
                        >
                          <div class="action-form-group">
                            <label>Rule Name</label>
                            <input
                              type="text"
                              class="form-control"
                              v-model="rule.name"
                            />
                          </div>
                          <div class="action-form-group">
                            <label>Description</label>
                            <input
                              type="text"
                              class="form-control"
                              v-model="rule.description"
                              placeholder="Briefly describe when this runs"
                            />
                          </div>
                          <div class="action-form-group action-form-row">
                            <div class="action-form-col">
                              <label>Match Pattern</label>
                              <input
                                type="text"
                                class="form-control"
                                placeholder="e.g. ^.{0,50}$"
                                v-model="rule.matchPattern"
                              />
                            </div>
                            <div class="action-form-col">
                              <label>Match Flags</label>
                              <input
                                type="text"
                                class="form-control"
                                placeholder="gimuy"
                                maxlength="6"
                                v-model="rule.matchFlags"
                              />
                            </div>
                          </div>
                          <div class="action-form-group action-form-row">
                            <div class="action-form-col">
                              <label>Replace Pattern</label>
                              <input
                                type="text"
                                class="form-control"
                                placeholder="e.g. [\\.!?]+$"
                                v-model="rule.replacePattern"
                              />
                            </div>
                            <div class="action-form-col">
                              <label>Replace Flags</label>
                              <input
                                type="text"
                                class="form-control"
                                placeholder="gimuy"
                                maxlength="6"
                                v-model="rule.replaceFlags"
                              />
                            </div>
                          </div>
                          <div class="action-form-group action-form-row">
                            <div class="action-form-col">
                              <label>Replacement</label>
                              <input
                                type="text"
                                class="form-control"
                                :disabled="rule.replacementMode !== 'literal'"
                                placeholder="Leave blank to remove"
                                v-model="rule.replacement"
                              />
                            </div>
                            <div class="action-form-col">
                              <label>Replacement Mode</label>
                              <select
                                class="form-control"
                                v-model="rule.replacementMode"
                              >
                                <option value="literal">Literal</option>
                                <option value="lowercase">
                                  Lowercase match
                                </option>
                                <option value="uppercase">
                                  Uppercase match
                                </option>
                              </select>
                            </div>
                          </div>
                          <p class="transformation-hint">
                            The match pattern decides when the rule runs. When it
                            matches, the replace pattern executes against the current
                            text. Set replacement mode to lowercase/uppercase to adjust
                            the matched text dynamically.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Rules Editor -->
                <div v-if="field.type === 'rules-editor'">
                  <div class="rules-editor-container">
                    <div class="rules-editor-toolbar">
                      <button
                        @click="addNewRule"
                        type="button"
                        class="btn btn-primary btn-sm"
                      >
                        <i class="ph-duotone ph-plus"></i> Add Rule
                      </button>
                      <button
                        @click="resetRulesToDefaults"
                        type="button"
                        class="btn btn-default btn-sm"
                      >
                        <i class="ph-duotone ph-arrow-clockwise"></i> Reset ({{ enabledRulesCount }}/{{ totalRulesCount }} enabled)
                      </button>
                    </div>
                    <div class="rules-list">
                      <div
                        v-if="!settings.rules?.length"
                        class="empty-rules-state"
                      >
                        <i class="ph-duotone ph-text-aa"></i>
                        <p>No rules configured</p>
                        <p class="empty-subtitle">
                          Add your first text transformation rule to get started
                        </p>
                      </div>
                      <div
                        v-for="(rule, index) in settings.rules || []"
                        :key="rule.id || index"
                        class="rule-card"
                        :class="{ expanded: expandedRules[rule.id || index] }"
                      >
                        <div
                          class="rule-card-header"
                          @click="toggleRuleCard(rule.id || index)"
                        >
                          <div class="rule-info">
                            <div class="rule-toggle">
                              <input
                                type="checkbox"
                                class="rule-enabled-checkbox checkbox"
                                v-model="rule.enabled"
                                @click.stop
                              />
                              <h4 class="rule-name" :title="rule.name">{{ rule.name }}</h4>
                            </div>
                            <p class="rule-description">
                              {{ rule.examples?.length || 0 }} {{ (rule.examples?.length || 0) === 1 ? 'example' : 'examples' }}
                              <span v-if="rule.if && rule.if.length > 0" class="rule-conditions">
                                â€¢ 
                                <span v-for="(condition, idx) in rule.if" :key="condition" class="condition-tag">
                                  <i :class="['ph-duotone', getConditionIcon(condition)]"></i>
                                </span>
                              </span>
                            </p>
                          </div>
                          <div class="rule-controls">
                            <i 
                              class="ph-duotone ph-arrow-up rule-move-btn"
                              @click.stop="moveRule(index, -1)"
                              :class="{ disabled: index === 0 }"
                              title="Move up"
                            ></i>
                            <i 
                              class="ph-duotone ph-arrow-down rule-move-btn"
                              @click.stop="moveRule(index, 1)"
                              :class="{ disabled: index === (settings.rules?.length || 0) - 1 }"
                              title="Move down"
                            ></i>
                            <button
                              type="button"
                              class="btn btn-icn-only btn-sm"
                              @click.stop="deleteRule(index)"
                              title="Delete rule"
                            >
                              <i class="ph-duotone ph-trash"></i>
                            </button>
                          </div>
                        </div>
                        <div
                          class="rule-card-body"
                          :class="{ collapsed: !expandedRules[rule.id || index] }"
                        >
                          <div class="rule-form-group">
                            <label>Instructions</label>
                            <input
                              type="text"
                              class="form-control"
                              v-model="rule.name"
                            />
                          </div>
                          <div class="rule-form-group">
                            <label>Requires (optional)</label>
                            <div class="conditions-list">
                              <label class="condition-checkbox" :class="{ active: rule.if && rule.if.includes('selection') }">
                                <input
                                  type="checkbox"
                                  :checked="rule.if && rule.if.includes('selection')"
                                  @change="updateRuleCondition(rule, 'selection', $event.target.checked)"
                                />
                                <i class="ph-duotone ph-selection"></i>
                                Selection
                              </label>
                              <label class="condition-checkbox" :class="{ active: rule.if && rule.if.includes('context') }">
                                <input
                                  type="checkbox"
                                  :checked="rule.if && rule.if.includes('context')"
                                  @change="updateRuleCondition(rule, 'context', $event.target.checked)"
                                />
                                <i class="ph-duotone ph-file-text"></i>
                                Document
                              </label>
                              <label class="condition-checkbox" :class="{ active: rule.if && rule.if.includes('writing_style') }">
                                <input
                                  type="checkbox"
                                  :checked="rule.if && rule.if.includes('writing_style')"
                                  @change="updateRuleCondition(rule, 'writing_style', $event.target.checked)"
                                />
                                <i class="ph-duotone ph-pen-nib"></i>
                                Writing style
                              </label>
                            </div>
                          </div>
                          <div class="section-header-small">
                            <h5>Examples ({{ rule.examples?.length || 0 }})</h5>
                            <button
                              type="button"
                              class="btn btn-sm"
                              @click="addNewExample(index)"
                            >
                              <i class="ph-duotone ph-plus"></i> Add
                            </button>
                          </div>
                          <div class="examples-list">
                            <div
                              v-for="(example, eIndex) in rule.examples || []"
                              :key="eIndex"
                              class="example-item"
                            >
                              <div class="example-controls">
                                <div class="example-inputs">
                                  <div class="example-column">
                                    <label>From</label>
                                    <textarea
                                      class="form-control example-textarea"
                                      placeholder="Input text..."
                                      v-model="example.from"
                                      rows="4"
                                    ></textarea>
                                  </div>
                                  <div class="example-column">
                                    <label>To</label>
                                    <textarea
                                      class="form-control example-textarea"
                                      placeholder="Expected output..."
                                      v-model="example.to"
                                      rows="4"
                                    ></textarea>
                                  </div>
                                </div>
                                <button
                                  type="button"
                                  class="btn btn-icn-only btn-negative btn-sm example-delete-btn"
                                  @click="deleteExample(index, eIndex)"
                                  title="Delete example"
                                >
                                  <i class="ph-duotone ph-trash"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  class="validation-error"
                  v-if="validationErrors[field.key]"
                >
                  {{ validationErrors[field.key] }}
                </div>
              </div>

              <!-- TRANSCRIPTION SECTION -->
              <div
                v-if="currentSection.id === 'transcription' && pluginData.plugins.length"
                class="plugin-options-section"
              >
                <div class="form-group">
                  <label
                    ><i class="ph-duotone ph-plugs-connected"></i> Active
                    Plugin</label
                  >
                  <select
                    class="form-control"
                    v-model="activePlugin"
                    @change="handlePluginChange"
                  >
                    <option
                      v-for="plugin in pluginData.plugins"
                      :key="plugin.name"
                      :value="plugin.name"
                    >
                      {{ plugin.displayName }}
                    </option>
                  </select>
                </div>
                <div
                  v-for="plugin in pluginData.plugins"
                  :key="plugin.name"
                  class="plugin-config-section"
                >
                  <div class="plugin-header">
                    <div class="plugin-info">
                      <h4>{{ plugin.displayName }}</h4>
                      <p class="plugin-description">{{ plugin.description }}</p>
                    </div>
                    <button
                      v-if="activePlugin !== plugin.name"
                      type="button"
                      @click="clearPluginData(plugin.name)"
                      class="btn btn-negative btn-sm"
                      title="Clear plugin data"
                    >
                      <i class="ph-duotone ph-trash"></i> Clear Data
                    </button>
                  </div>
                  <div v-if="activePlugin === plugin.name">
                    <div
                      v-for="option in pluginData.schemas[plugin.name]"
                      :key="option.key"
                      class="form-group plugin-option"
                    >
                      <label v-if="option.type !== 'boolean'"
                        >{{ option.label }}</label
                      >
                      <div v-if="option.description" class="field-description">
                        {{ option.description }}
                      </div>
                      <select
                        v-if="option.type === 'model-select' || option.type === 'select'"
                        class="form-control"
                        :value="settings.plugin[plugin.name][option.key]"
                        @change="handleOptionChange(plugin.name, option, $event.target.value)"
                      >
                        <option
                          v-for="opt in option.options"
                          :value="opt.value"
                        >
                          {{ opt.label }}{{ opt.size ? ` (${opt.size})` : '' }}
                        </option>
                      </select>
                      <div
                        v-else-if="option.type === 'boolean'"
                        class="checkbox-container"
                      >
                        <input
                          type="checkbox"
                          class="checkbox"
                          :id="`plugin-${plugin.name}-${option.key}`"
                          v-model="settings.plugin[plugin.name][option.key]"
                        />
                        <label :for="`plugin-${plugin.name}-${option.key}`"
                          >{{ option.label }}</label
                        >
                      </div>
                      <input
                        v-else-if="option.type === 'number'"
                        type="number"
                        class="form-control"
                        v-model.number="settings.plugin[plugin.name][option.key]"
                        :min="option.min"
                        :max="option.max"
                        :step="option.step || 1"
                      />
                      <input
                        v-else
                        type="text"
                        class="form-control"
                        v-model="settings.plugin[plugin.name][option.key]"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- DATA MANAGEMENT SECTION -->
              <div
                v-if="currentSection.id === 'data'"
                class="data-management-section"
              >
                <!-- Total Data Usage Summary -->
                <div class="total-data-usage-summary">
                  <div class="usage-stats">
                    <div class="usage-item">
                      <i class="ph-duotone ph-chart-pie"></i>
                      <span class="usage-label">Total Usage:</span>
                      <span class="usage-value">{{ formatBytes(totalDataUsage) }}</span>
                    </div>
                    <div class="usage-item">
                      <i class="ph-duotone ph-folder-simple"></i>
                      <span class="usage-label">Plugins with Data:</span>
                      <span class="usage-value">{{ pluginCountWithData }}</span>
                    </div>
                  </div>
                </div>

                <div class="section-header-small">
                  <h5>Plugin Data Management</h5>
                  <div class="header-actions">
                    <button
                      type="button"
                      @click="clearAllPluginData"
                      class="btn btn-negative btn-sm"
                      :disabled="isClearingAll || !pluginDataInfo.length"
                      title="Clear all data from all plugins"
                    >
                      <i class="ph-duotone ph-trash"></i>
                      Clear All Data
                    </button>
                    <button
                      type="button"
                      @click="refreshDataManagement"
                      class="btn btn-sm refresh-btn"
                      title="Refresh data management"
                    >
                      <i class="ph-duotone ph-arrow-clockwise"></i> Refresh
                    </button>
                  </div>
                </div>
                <div class="plugin-data-list">
                  <div v-if="!pluginDataInfo.length" class="loading-indicator">
                    <i
                      class="ph-duotone ph-circle-notch"
                      style="animation: spin 1s linear infinite"
                    ></i
                    >Loading...
                  </div>
                  <template v-for="plugin in pluginDataInfo" :key="plugin.name">
                    <div
                      class="plugin-data-item"
                      :class="{ active: plugin.isActive }"
                    >
                      <div class="plugin-data-info">
                        <div class="plugin-data-info-content">
                          <div>
                            <div class="plugin-name">
                              {{ plugin.displayName }}
                              <span v-if="plugin.isActive" class="active-badge"
                                >Active</span
                              >
                            </div>
                            <div class="plugin-data-details-summary">
                              <span class="data-size"
                                ><i class="ph-duotone ph-hard-drive"></i> {{
                                formatBytes(plugin.dataSize) }}</span
                              >
                            </div>
                          </div>
                          <div class="plugin-data-actions">
                            <button
                              type="button"
                              @click="togglePluginDetails(plugin.name)"
                              class="btn btn-sm plugin-details-btn"
                              title="View Details"
                            >
                              <i class="ph-duotone ph-list-bullets"></i>
                            </button>
                            <button
                              v-if="!plugin.isActive"
                              type="button"
                              @click="clearPluginData(plugin.name)"
                              class="btn btn-negative btn-sm"
                              title="Clear All"
                            >
                              <i class="ph-duotone ph-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    <div
                      class="plugin-data-details"
                      v-if="expandedDataPlugins[plugin.name]"
                    >
                      <div class="plugin-data-details-header">
                        <h6>Data Items</h6>
                        <span class="item-count"
                          >{{ pluginDataItems[plugin.name]?.length || 0 }}
                          items</span
                        >
                      </div>
                      <div
                        v-if="!pluginDataItems[plugin.name]"
                        class="loading-indicator"
                      >
                        <i
                          class="ph-duotone ph-circle-notch"
                          style="animation: spin 1s linear infinite"
                        ></i
                        >Loading...
                      </div>
                      <div
                        v-else-if="!pluginDataItems[plugin.name].length"
                        class="empty-state"
                      >
                        <i class="ph-duotone ph-folder-open"></i>
                        <p>No data items found</p>
                      </div>
                      <div v-else class="plugin-data-items">
                        <div
                          v-for="item in pluginDataItems[plugin.name]"
                          :key="item.id"
                          class="plugin-data-item-detail"
                        >
                          <div class="item-info">
                            <div class="item-size">
                              {{ formatBytes(item.size) }}
                            </div>
                            <div class="item-name" :title="item.description">{{ item.name }}</div>
                          </div>
                          <div class="item-actions">
                            <button
                              type="button"
                              @click="deletePluginDataItem(plugin.name, item.id, item.name)"
                              class="btn btn-xs btn-negative delete-item-btn"
                              title="Delete"
                            >
                              <i class="ph-duotone ph-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <div v-if="currentSectionId !== 'permissions'" class="form-actions">
              <button
                type="submit"
                class="btn btn-primary"
                :disabled="isSaving"
              >
                <span v-if="isSaving" class="spinner"></span>
                <i v-if="!isSaving" class="ph-duotone ph-floppy-disk"></i>
                Save Settings
              </button>
              <button
                @click="cancelChanges"
                type="button"
                class="btn btn-default"
              >
                <i class="ph-duotone ph-x-circle"></i>
                Cancel
              </button>
              <button
                @click="resetSection"
                type="button"
                class="btn btn-negative"
              >
                <i class="ph-duotone ph-arrow-counter-clockwise"></i>
                Reset Section
              </button>
            </div>
          </form>

          <!-- Permissions Content -->
          <div v-if="currentSectionId === 'permissions'" class="settings-section">
            <div class="section-header">
              <i class="ph-duotone ph-shield"></i>
              <div>
                <h2 class="section-title">Permissions</h2>
                <p class="section-description">
                  Manage system permissions required by WhisperMac for full functionality
                </p>
              </div>
            </div>

            <!-- Accessibility Permission -->
            <div class="form-group" :class="{ 'permission-granted': permissions?.accessibility?.granted }">
              <label>
                <i class="ph-duotone ph-cursor-click"></i>
                Accessibility Permissions
              </label>
              <div class="field-description">
                Required for WhisperMac to automatically insert transcribed text where you're typing.
              </div>
              <div class="permission-status-container">
                <span class="status-badge" :class="getAccessibilityStatusClass()">
                  {{ getAccessibilityStatusText() }}
                </span>
                <span v-if="permissions?.accessibility?.error" class="status-error">
                  {{ permissions.accessibility.error }}
                </span>
              </div>
              <div class="permission-actions">
                <button
                  type="button"
                  class="btn btn-sm btn-primary"
                  @click="openAccessibilitySettings"
                >
                  <i class="ph-duotone ph-gear"></i>
                  Open Settings
                </button>
              </div>
            </div>

            <!-- Microphone Permission -->
            <div class="form-group" :class="{ 'permission-granted': permissions?.microphone?.granted }">
              <label>
                <i class="ph-duotone ph-microphone"></i>
                Microphone Permissions
              </label>
              <div class="field-description">
                Required for WhisperMac to capture your voice for transcription and dictation.
              </div>
              <div class="permission-status-container">
                <span class="status-badge" :class="getMicrophoneStatusClass()">
                  {{ getMicrophoneStatusText() }}
                </span>
                <span v-if="permissions?.microphone?.error" class="status-error">
                  {{ permissions.microphone.error }}
                </span>
              </div>
              <div class="permission-actions">
                <button
                  type="button"
                  class="btn btn-sm btn-primary"
                  @click="openMicrophoneSettings"
                >
                  <i class="ph-duotone ph-gear"></i>
                  Open Settings
                </button>
              </div>
            </div>

            <!-- Global Actions -->
            <div class="form-group">
              <label>
                <i class="ph-duotone ph-gear-six"></i>
                Quick Actions
              </label>
              <div class="field-description">
                Manage permissions and open system settings.
              </div>
              <div class="permission-actions">
                <button
                  type="button"
                  class="btn btn-default"
                  @click="refreshAllPermissions"
                  :disabled="isRefreshingAll"
                >
                  <i v-if="isRefreshingAll" class="ph-duotone ph-circle-notch spinning"></i>
                  <i v-else class="ph-duotone ph-arrows-clockwise"></i>
                  {{ isRefreshingAll ? 'Refreshing...' : 'Refresh All' }}
                </button>
                <button
                  type="button"
                  class="btn btn-default"
                  @click="openSystemPreferences"
                >
                  <i class="ph-duotone ph-gear-six"></i>
                  Open System Settings
                </button>
              </div>
            </div>

            <!-- Help Information -->
            <div class="form-group info-group">
              <label>
                <i class="ph-duotone ph-info"></i>
                Important Information
              </label>
              <div class="field-description">
                <p><strong>Note:</strong> Permission changes take effect immediately in most cases.</p>
                <p>If features aren't working after granting permissions, try refreshing the status or restarting the app.</p>
                <p>WhisperMac will show permission dialogs when needed if permissions are missing.</p>
              </div>
            </div>
          </div>
        </main>



        <!-- About Section -->
        <main class="settings-content about-content" v-if="currentSectionId === 'about'">
          <div class="about-container">
            <div class="about-header">
              <img src="../assets/icon.png" alt="WhisperMac Icon" class="about-app-icon" />
              <h1 class="about-app-name">{{ packageInfo?.name || 'WhisperMac' }}</h1>
              <a v-if="packageInfo?.repository?.url" href="#" @click.prevent="openExternalLink(getReleasesUrl())" class="about-app-version">Version {{ appVersion }}</a>
              <span v-else class="about-app-version">Version {{ appVersion }}</span>
              <p class="about-app-description">
                {{ packageInfo?.description || 'AI-powered dictation for Mac using multiple transcription engines' }}
              </p>
              <a v-if="packageInfo?.author" href="#" @click="openAuthorLink" class="about-app-author">By {{ packageInfo.author }}</a>
              <span v-else class="about-app-author">By Explosion-Scratch</span>
            </div>

            <div class="about-actions">
              <button
                type="button"
                @click="importAllSettings"
                class="btn btn-primary about-action-btn"
              >
                <i class="ph-duotone ph-download-simple"></i>
                Import Settings
              </button>
              <button
                type="button"
                @click="exportAllSettings"
                class="btn btn-primary about-action-btn"
              >
                <i class="ph-duotone ph-upload-simple"></i>
                Export Settings
              </button>
            </div>

            <div class="about-footer">
              <p class="about-footer-text">
                Import or export all your WhisperMac settings to backup or transfer between installations.
              </p>
              <div v-if="packageInfo" class="about-footer-details">
                <p v-if="packageInfo.license" class="about-footer-text">
                  License: {{ packageInfo.license }}
                </p>
                <p v-if="packageInfo.homepage" class="about-footer-text">
                  <a href="#" @click.prevent="openExternalLink(packageInfo.homepage)" class="about-footer-link">Homepage</a>
                  <span v-if="packageInfo.bugs?.url"> â€¢ </span>
                  <a v-if="packageInfo.bugs?.url" href="#" @click.prevent="openExternalLink(packageInfo.bugs.url)" class="about-footer-link">Report Issues</a>
                  <span v-if="packageInfo.repository?.url"> â€¢ </span>
                  <a v-if="packageInfo.repository?.url" href="#" @click.prevent="openExternalLink(getRepoUrl())" class="about-footer-link">Repository</a>
                </p>
              </div>
            </div>
          </div>
        </main>
      </div>

      <div
        class="status-message"
        :class="[status.type, { show: status.visible }]"
      >
        {{ status.message }}
      </div>

      <div class="progress-overlay" :class="{ show: progress.visible }">
        <div>{{ progress.message }}</div>
        <div class="progress-bar-container">
          <div
            class="progress-bar-fill"
            :style="{ width: progress.percent + '%' }"
          ></div>
        </div>
      </div>
    </div>

    <script src="./vue.js"></script>
    <script src="settingsWindow.js"></script>
  </body>
</html>
